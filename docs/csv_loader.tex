% Autogenerated translation of csv_loader.md by Texpad
% To stop this file being overwritten during the typeset process, please move or remove this header

\documentclass[12pt]{book}
\usepackage{graphicx}
\usepackage{fontspec}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,left=.5in,right=.5in,top=.3in,bottom=0.3in]{geometry}
\setlength\parindent{0pt}
\setlength{\parskip}{\baselineskip}
\setmainfont{Helvetica Neue}
\usepackage{hyperref}
\pagestyle{plain}
\begin{document}

\chapter*{CSV载入模块}

CSV载入模块在vnpy根目录下vnpyappcsv\_loader文件夹内，engine.py里面的CsvLoaderEngine类负责载入功能实现。

\section*{初始化配置}

初始化数据载入相关信息，可以分成3类：

\begin{itemize}
\item CSV文件路径
\item 合约信息：合约代码、交易所、K线周期
\item CSV表头信息：日期时间、开盘价、最高价、最低价、收盘价、成交量
\end{itemize}

```
        self.file\_path: str = ''

\begin{verbatim}
    self.symbol: str = ""
    self.exchange: Exchange = Exchange.SSE
    self.interval: Interval = Interval.MINUTE

    self.datetime_head: str = ''
    self.open_head: str = ''
    self.close_head: str = ''
    self.low_head: str = ''
    self.high_head: str = ''
    self.volume_head: str = ''
\end{verbatim}

```

~

\section*{数据载入}

从文件路径中读取CSV文件，然后在每一次迭代中载入数据到数据库中。
```
        with open(file\_path, 'rt') as f:
            reader = csv.DictReader(f)

\begin{verbatim}
        for item in reader:
\end{verbatim}

```

~

载入数据的方法可以分成2类：
- 直接插入：合约代码、交易所、K线周期、成交量、开盘价、最高价、最低价、收盘价、接口名称
- 需要处理：日期时间（根据其相应的时间格式，通过strptime()转化成时间元祖）、vt\_symbol(合约代码.交易所格式，如rb1905.SHFE)

注意：db\emph{bar.replace()用于数据更新，即把旧的数据替换成新的。
```
                db}bar.symbol = symbol
                db\emph{bar.exchange = exchange.value
                db}bar.datetime = datetime.strptime(
                    item[datetime\emph{head], datetime}format
                )
                db\emph{bar.interval = interval.value
                db}bar.volume = item[volume\emph{head]
                db}bar.open\emph{price = item[open}head]
                db\emph{bar.high}price = item[high\emph{head]
                db}bar.low\emph{price = item[low}head]
                db\emph{bar.close}price = item[close\emph{head]
                db}bar.vt\emph{symbol = vt}symbol
                db\emph{bar.gateway}name = "DB"

\begin{verbatim}
            db_bar.replace()
\end{verbatim}

```

\end{document}
